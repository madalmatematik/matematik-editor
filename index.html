<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Matematiksel Metin Düzenleyici</title>

  <!-- KaTeX (ONLINE / CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <!-- PNG / PDF (ONLINE / CDN) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg1:#5865f2; --bg2:#9b59b6;
      --card:#fff; --text:#111827; --muted:#6b7280; --border:#cbd5e0;
    }
    body{
      margin:0; padding:18px;
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh; box-sizing:border-box;
    }
    .container{
      max-width:980px; margin:0 auto;
      background:var(--card);
      border-radius:16px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
    }
    .header{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      padding:8px 6px 16px 6px;
      border-bottom:3px solid #6b7bd6;
      margin-bottom:16px;
    }
    .header h1{ margin:0; font-size:24px; color:var(--text); }
    .toggle{
      display:flex; align-items:center; gap:10px;
      color:var(--muted); font-weight:700; user-select:none;
    }
    .section-title{
      font-weight:800; color:#374151;
      letter-spacing:.2px; margin:14px 0 8px;
      text-transform:uppercase; font-size:12px;
      display:flex; align-items:center; gap:8px;
    }
    select,input[type="number"],textarea{
      width:100%; box-sizing:border-box;
      border-radius:10px; border:2px solid var(--border);
      padding:10px 12px; outline:none; font-size:14px;
    }
    textarea{
      height:140px; resize:vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }
    .muted{ color:var(--muted); font-weight:600; }
    .controls{
      background:#f7f8fb; border-radius:12px; padding:14px;
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px;
    }
    .control-item{ display:flex; flex-direction:column; gap:6px; }
    .label{
      font-size:12px; font-weight:800; color:#374151;
      letter-spacing:.2px; text-transform:uppercase;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btns{
      display:grid; grid-template-columns:repeat(5,1fr);
      gap:12px; margin:14px 0;
    }
    button{
      cursor:pointer; border:none; border-radius:12px;
      padding:14px 10px; color:#fff; font-weight:900;
      letter-spacing:.3px; font-size:14px;
    }
    .btn-view{ background:linear-gradient(135deg,#6b7bd6,#5850ec); }
    .btn-clear{ background:linear-gradient(135deg,#ff6aa2,#b72fd7); }
    .btn-copy{ background:linear-gradient(135deg,#00bcd4,#3b82f6); }
    .btn-png{ background:linear-gradient(135deg,#ff8a00,#ff3d7f); }
    .btn-pdf{ background:linear-gradient(135deg,#5b5bd6,#7c3aed); }
    .hint{
      border:2px solid #eab308; background:#fff7cc;
      border-radius:10px; padding:10px 12px;
      color:#3f3f46; font-weight:700;
      margin:10px 0 14px;
    }
    #preview{
      min-height:190px;
      border:2px dashed var(--border);
      border-radius:12px;
      padding:14px;
      box-sizing:border-box;
      background:transparent; /* default: şeffaf */
      overflow:auto;
    }
    .line{ margin:2px 0; }
    .line.text{ white-space:pre-wrap; }
    .line.blank{ height:10px; }
    .history{
      margin-top:14px;
      background:#f7f8fb; border-radius:12px; padding:12px;
      max-height:240px; overflow:auto;
    }
    .history h3{ margin:0 0 10px 0; font-size:14px; color:#374151; }
    .history-item{
      background:#fff; border-left:4px solid #6b7bd6;
      border-radius:10px; padding:10px;
      margin-bottom:8px; cursor:pointer;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:13px; color:#111827;
    }
    .history-item:hover{ background:#f2f5ff; }

    @media (max-width:820px){
      .controls{ grid-template-columns:1fr; }
      .btns{ grid-template-columns:1fr 1fr; }
    }
  </style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>Matematiksel Metin Düzenleyici</h1>

    <!-- İlk açılışta seçili OLMASIN -->
    <label class="toggle">
      <input id="autoRenderCheck" type="checkbox">
      Otomatik Render
    </label>
  </div>

  <div class="section-title">Örnek Şablonlar</div>
  <select id="templateSelect">
    <option value="">Seçiniz...</option>
    <option value="1">Parabol Fonksiyonu</option>
    <option value="2">Türev Örneği</option>
    <option value="3">İntegral Örneği</option>
    <option value="4">Limit Örneği</option>
    <option value="5">Trigonometri</option>
    <option value="6">Matris</option>
  </select>
  <div id="templateInfo" class="muted" style="margin:8px 0 10px;">Bir şablon seçin...</div>

  <textarea id="inputArea" placeholder="Buraya metni yapıştırın..."></textarea>

  <div class="controls" style="margin-top:12px;">
    <div class="control-item">
      <div class="label">Yazı Tipi</div>
      <select id="fontSelect">
        <option value="Arial" selected>Arial</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="Calibri">Calibri</option>
        <option value="Georgia">Georgia</option>
      </select>
    </div>

    <div class="control-item">
      <div class="label">Boyut (px)</div>
      <input id="sizeInput" type="number" value="22" min="10" max="80">
    </div>

    <div class="control-item">
      <div class="label">Metin Rengi</div>
      <input id="colorInput" type="color" value="#000000">
    </div>

    <div class="control-item">
      <div class="label">Arka Plan</div>
      <input id="bgColorInput" type="color" value="#ffffff">
      <!-- İlk açılışta ŞEFFAF seçili -->
      <label class="row" style="margin-top:8px; color:#374151; font-weight:700;">
        <input id="transparentBg" type="checkbox" checked>
        Şeffaf
      </label>
    </div>

    <div class="control-item">
      <div class="label">Hizalama</div>
      <select id="alignSelect">
        <option value="left">Sola</option>
        <option value="center">Ortala</option>
        <option value="right">Sağa</option>
        <!-- İlk açılışta İKİ YANA YASLA seçili -->
        <option value="justify" selected>İki Yana Yasla</option>
      </select>
    </div>

    <div class="control-item">
      <div class="label">Stil</div>
      <label class="row" style="color:#374151; font-weight:700;">
        <input id="boldCheck" type="checkbox">
        Kalın
      </label>
    </div>
  </div>

  <div class="btns">
    <button class="btn-view" onclick="islemYap()">GÖRÜNTÜLE</button>
    <button class="btn-clear" onclick="temizle()">TEMİZLE</button>
    <button class="btn-copy" onclick="kopyala()">KOPYALA</button>
    <button class="btn-png" onclick="pngIndir()">PNG İNDİR</button>
    <button class="btn-pdf" onclick="pdfIndir()">PDF İNDİR</button>
  </div>

  <div class="hint">
    Şeffaf PNG için: Şeffaf seçeneğini işaretleyin, sonra preview alanına sağ tıklayıp “Resim Olarak Kaydet” seçin.
  </div>

  <div id="preview"><div class="muted">Yapıştırdığınız metin burada işlenmiş olarak görünecek...</div></div>

  <div class="history">
    <h3>GEÇMİŞ (Son 5)</h3>
    <div id="historyList"></div>
  </div>
</div>

<script>
  // =========================
  // OTURUM DAVRANIŞI
  // İlk açılışta auto kapalı.
  // İlk "GÖRÜNTÜLE" tıklamasından sonra, uygulama kapanana kadar auto açık (oturum).
  // =========================
  let sessionAutoEnabled = false;

  // ---------- Veri ----------
  let history = JSON.parse(localStorage.getItem('mathHistory') || '[]');

  const templates = {
    '1': 'f(x) = x^2 - 4x + 3\nTepe noktası: (2, -1)',
    '2': "f(x) = 3x^2 + 2x - 5\nf'(x) = 6x + 2",
    '3': '\\int_{0}^{1} x^2\\,dx = \\frac{1}{3}',
    '4': '\\lim_{x \\to 0} \\frac{\\sin x}{x} = 1',
    '5': '\\sin^2(x) + \\cos^2(x) = 1',
    '6': '\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}'
  };
  const templateInfos = {
    '1':'Parabol fonksiyonu örneği',
    '2':'Türev alma örneği',
    '3':'Belirli integral örneği',
    '4':'Limit hesaplama örneği',
    '5':'Trigonometrik özdeşlik',
    '6':'Matris gösterimi'
  };

  // ---------- Yardımcılar ----------
  function escapeHtml(str){
    return str.replaceAll('&','&').replaceAll('<','<').replaceAll('>','>');
  }
  function normalizeInput(raw){
    if(!raw) return '';
    let t = raw;
    t = t.replace(/\r\n?/g,'\n')
         .replace(/\u00A0/g,' ')
         .replace(/\u2009|\u200A|\u202F/g,' ')
         .replace(/\u2212/g,'-')
         .replace(/\u2013|\u2014/g,'-')
         .replace(/[\u2018\u2019]/g,"'")
         .replace(/[\u201C\u201D]/g,'"');
    t = t.split('\n').map(l => l.replace(/[ \t]+$/g,'')).join('\n');
    return t.trimEnd();
  }
  function containsExplicitDelimiters(text){
    // zaten $...$ veya $$...$$ veya \( \) \[ \] varsa elleme
    return /\$\$[\s\S]+?\$\$|\$[^$]+\$|\\\(|\\\)|\\\[|\\\]/.test(text);
  }
  function looksLikeMath(line){
    const l = line.trim();
    if(!l) return false;

    // begin/end env
    if(/\\begin\{.*?\}|\\end\{.*?\}/.test(l)) return true;

    // Türkçe karakter yoğun satırları metin say (Latex komutu yoksa)
    const hasTR = /[ğüşöçıİĞÜŞÖÇ]/.test(l);
    const hasLatexCmd = /\\[a-zA-Z]+/.test(l);
    if(hasTR && !hasLatexCmd) return false;

    // temel math sinyalleri
    return /\\[a-zA-Z]+|[\^_]|=|[<>]=?|\\(frac|sqrt|int|sum|prod|lim|sin|cos|tan|log|ln|pi|theta|alpha|beta|gamma|cdot|times|pm|leq|geq|neq|infty)\b/.test(l);
  }

  function applyStyles(){
    const preview = document.getElementById('preview');
    preview.style.fontFamily = document.getElementById('fontSelect').value;
    preview.style.fontSize = document.getElementById('sizeInput').value + 'px';
    preview.style.color = document.getElementById('colorInput').value;
    preview.style.textAlign = document.getElementById('alignSelect').value;
    preview.style.fontWeight = document.getElementById('boldCheck').checked ? 'bold' : 'normal';

    if(document.getElementById('transparentBg').checked){
      preview.style.backgroundColor = 'transparent';
    } else {
      preview.style.backgroundColor = document.getElementById('bgColorInput').value;
    }
  }

  function buildPreviewHTML(rawText){
    const text = normalizeInput(rawText);
    if(!text.trim()) return '<div class="muted">Yapıştırdığınız metin burada işlenmiş olarak görünecek...</div>';

    // kullanıcı delimiter vermişse direkt göster (KaTeX zaten bunu render eder)
    if(containsExplicitDelimiters(text)){
      return escapeHtml(text).replaceAll('\n','<br>');
    }

    // delimiter yoksa: satır satır, math olanları $$...$$ içine sar
    const lines = text.split('\n');
    return lines.map(line=>{
      const l = line.trim();
      if(!l) return '<div class="line blank">&nbsp;</div>';
      if(looksLikeMath(l)) return `<div class="line math">$$${escapeHtml(l)}$$</div>`;
      return `<div class="line text">${escapeHtml(line)}</div>`;
    }).join('');
  }

  function katexReady(timeoutMs=5000){
    const start = Date.now();
    return new Promise(resolve=>{
      (function tick(){
        if(window.katex && window.renderMathInElement) return resolve(true);
        if(Date.now()-start>=timeoutMs) return resolve(false);
        setTimeout(tick,60);
      })();
    });
  }

  async function renderPreview(force=false){
    applyStyles();

    const preview = document.getElementById('preview');
    const input = document.getElementById('inputArea').value;
    preview.innerHTML = buildPreviewHTML(input);

    const ok = await katexReady();
    if(!ok) return;

    // Auto ON koşulu:
    // - checkbox açıksa veya
    // - oturumda "ilk görüntüle" sonrası sessionAutoEnabled true ise
    const autoOn = document.getElementById('autoRenderCheck').checked || sessionAutoEnabled;

    // Auto kapalıysa yalnızca force=true ile render et
    if(!autoOn && !force) return;

    try{
      renderMathInElement(preview,{
        delimiters:[
          {left:'$$', right:'$$', display:true},
          {left:'$', right:'$', display:false},
          {left:'\\(', right:'\\)', display:false},
          {left:'\\[', right:'\\]', display:true}
        ],
        throwOnError:false
      });
    }catch(e){ console.error(e); }
  }

  // ---------- Geçmiş ----------
  function addHistory(text){
    const t = normalizeInput(text);
    if(!t.trim()) return;
    history = history.filter(h=>h!==t);
    history.unshift(t);
    history = history.slice(0,5);
    localStorage.setItem('mathHistory', JSON.stringify(history));
    showHistory();
  }
  function showHistory(){
    const list = document.getElementById('historyList');
    if(!history.length){ list.innerHTML = '<div class="muted">Henüz kayıt yok.</div>'; return; }
    list.innerHTML = history.map(item=>{
      const safe = escapeHtml(item).replaceAll('\n','<br>');
      return `<div class="history-item" data-raw="${escapeHtml(item)}" onclick="pickHistory(this)">${safe}</div>`;
    }).join('');
  }
  function pickHistory(el){
    const raw = el.getAttribute('data-raw') || '';
    const txt = raw.replaceAll('<','<').replaceAll('>','>').replaceAll('&','&');
    document.getElementById('inputArea').value = txt;

    // Geçmişten seçince de "görüntüle" mantığı gibi davran
    sessionAutoEnabled = true;
    document.getElementById('autoRenderCheck').checked = true;

    renderPreview(true);
  }

  // ---------- Butonlar ----------
  function islemYap(){
    const input = document.getElementById('inputArea').value;
    if(!input.trim()) return;

    // İSTEK: İlk GÖRÜNTÜLE'den sonra, uygulama kapanana kadar otomatik render çalışsın
    sessionAutoEnabled = true;
    document.getElementById('autoRenderCheck').checked = true;

    renderPreview(true);   // force render
    addHistory(input);
  }

  function temizle(){
    document.getElementById('inputArea').value = '';
    document.getElementById('preview').innerHTML = '<div class="muted">Yapıştırdığınız metin burada işlenmiş olarak görünecek...</div>';
    document.getElementById('templateSelect').value = '';
    document.getElementById('templateInfo').textContent = 'Bir şablon seçin...';
  }

  function kopyala(){
    const text = document.getElementById('preview').innerText || '';
    navigator.clipboard.writeText(text).then(()=>alert('Kopyalandı.')).catch(()=>alert('Kopyalama başarısız.'));
  }

  async function pngIndir(){
    const preview = document.getElementById('preview');
    await renderPreview(true);
    html2canvas(preview,{
      backgroundColor: document.getElementById('transparentBg').checked ? null : preview.style.backgroundColor,
      scale: 2
    }).then(canvas=>{
      const link=document.createElement('a');
      link.download='matematik.png';
      link.href=canvas.toDataURL('image/png');
      link.click();
    });
  }

  async function pdfIndir(){
    const preview = document.getElementById('preview');
    await renderPreview(true);
    html2canvas(preview,{
      backgroundColor: document.getElementById('transparentBg').checked ? null : preview.style.backgroundColor,
      scale: 2
    }).then(canvas=>{
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p','pt','a4');
      const pageW = pdf.internal.pageSize.getWidth();
      const imgW = pageW - 40;
      const imgH = canvas.height * imgW / canvas.width;
      pdf.addImage(imgData,'PNG',20,20,imgW,imgH);
      pdf.save('matematik.pdf');
    });
  }

  // ---------- Başlangıç ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    const sel = document.getElementById('templateSelect');
    const info = document.getElementById('templateInfo');

    sel.addEventListener('change', ()=>{
      const v = sel.value;
      if(!v) return;
      document.getElementById('inputArea').value = templates[v] || '';
      info.textContent = templateInfos[v] || '';
      // Otomatik render oturumda açılmışsa yazınca render eder; değilse sadece görünüm günceller
      renderPreview(false);
    });

    // Checkbox değişince:
    // - açılırsa anında render et
    // - kapanırsa sessionAutoEnabled'i kapatma (istenirse kapatırız)
    document.getElementById('autoRenderCheck').addEventListener('change', ()=>{
      const isOn = document.getElementById('autoRenderCheck').checked;
      if(isOn) renderPreview(true);
      else renderPreview(false);
    });

    // Input değişince:
    // - sessionAutoEnabled veya checkbox açıksa otomatik render eder
    let tmr = null;
    const input = document.getElementById('inputArea');
    const schedule = () => {
      clearTimeout(tmr);
      tmr = setTimeout(()=>renderPreview(false), 250);
    };
    input.addEventListener('input', schedule);
    input.addEventListener('paste', ()=>setTimeout(()=>renderPreview(false),0));

    // Stil değişiklikleri
    ['fontSelect','sizeInput','colorInput','bgColorInput','alignSelect','boldCheck','transparentBg']
      .forEach(id=>{
        const el = document.getElementById(id);
        el.addEventListener('input', schedule);
        el.addEventListener('change', schedule);
      });

    showHistory();
    applyStyles(); // ilk açılışta şeffaf + justify uygulanır
  });
</script>
</body>
</html>
```0
