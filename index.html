<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matematiksel Metin Düzenleyici</title>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <!-- html2canvas + jsPDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --ink:#111827; --muted:#6b7280; --border:#e5e7eb;
      --btn1:#5b7cfa; --btn2:#ff5fa2; --btn3:#00c2a8; --btn4:#ffb020; --btn5:#7a5cff;
      --shadow:0 8px 24px rgba(17,24,39,.08); --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(90deg,#5b3df2 0%,#5f60ff 50%,#6c3bff 100%);color:var(--ink);}
    .wrap{max-width:980px;margin:22px auto;padding:0 14px 40px;}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.35);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;}
    .header{display:flex;align-items:center;justify-content:space-between;padding:18px 18px 10px;}
    .title{font-weight:900;font-size:20px;letter-spacing:.2px;}
    .top-actions{display:flex;gap:10px;padding:0 18px 14px;flex-wrap:wrap;}
    .btn{border:0;color:#fff;font-weight:900;letter-spacing:.3px;padding:12px 16px;border-radius:12px;cursor:pointer;min-width:160px;}
    .btn:active{transform:translateY(1px);}
    .b1{background:linear-gradient(90deg,var(--btn1),#7b61ff);}
    .b2{background:linear-gradient(90deg,var(--btn2),#ff7a7a);}
    .b3{background:linear-gradient(90deg,#00b7ff,var(--btn3));}
    .b4{background:linear-gradient(90deg,var(--btn4),#ff6f00);}
    .b5{background:linear-gradient(90deg,var(--btn5),#3b82f6);}

    .body{padding:14px 18px 18px;background:var(--bg);border-top:1px solid rgba(17,24,39,.06);}
    .grid{display:grid;grid-template-columns:1.35fr .65fr;gap:14px;align-items:start;}
    @media (max-width:880px){.grid{grid-template-columns:1fr}.btn{min-width:140px;flex:1}}

    .box{background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(17,24,39,.06);}
    .label{font-size:12px;font-weight:900;color:var(--muted);letter-spacing:.6px;text-transform:uppercase;margin:2px 0 8px;}
    textarea{width:100%;min-height:260px;resize:vertical;border:1px solid var(--border);border-radius:12px;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:15px;line-height:1.35;outline:none;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width:640px){.row{grid-template-columns:1fr}}
    input[type="text"],input[type="number"],select{width:100%;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:15px;outline:none;background:#fff;}
    .check{display:flex;gap:8px;align-items:center;user-select:none;font-size:14px;color:var(--ink);font-weight:800;}
    .check small{font-weight:700;color:var(--muted)}
    .check input{transform:scale(1.1);}

    .status{display:flex;gap:10px;flex-wrap:wrap;padding:10px 0 6px;}
    .pill{background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px;display:flex;gap:8px;align-items:center;font-weight:900;color:var(--ink);font-size:13px;}
    .dot{width:10px;height:10px;border-radius:50%;background:#ef4444;box-shadow:0 0 0 3px rgba(239,68,68,.18);}
    .dot.ok{background:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.18);}

    .exportHint{margin:10px 0 0;padding:10px 12px;border-radius:12px;background:#fff7ed;border:1px solid #fed7aa;color:#7c2d12;font-weight:800;}

    .previewWrap{background:#fff;border:1px solid #d1d5db;border-radius:14px;padding:14px;}
    .page{background:#fff;border:2px dashed #cbd5e1;border-radius:14px;padding:18px;position:relative;overflow:hidden;}
    .meb{color:var(--ink);font-size:18px;line-height:1.6;overflow-wrap:anywhere;hyphens:auto;}
    .meb.justify{text-align:justify;}
    .meb.left{text-align:left;}
    .meb.center{text-align:center;}
    .p{margin:0 0 12px 0;}
    .p:last-child{margin-bottom:0;}
    .lbl{font-weight:900;}
    .resultLine{font-weight:900;}

    /* Display denklemler SOLA yaslı */
    .katex-display{ text-align:left !important; margin:8px 0 14px 0 !important; }
    .katex-display > .katex{ display:inline-block !important; text-align:left !important; }

    .history{margin-top:12px;background:#fff;border:1px solid var(--border);border-radius:14px;overflow:hidden;}
    .historyHead{padding:10px 12px;font-weight:900;color:var(--muted);background:#fafafa;border-bottom:1px solid var(--border);}
    .historyItem{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;}
    .historyItem:last-child{border-bottom:0;}
    .historyItem b{display:block;margin-bottom:4px}
    .historyItem small{color:var(--muted);}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="title">Matematiksel Metin Düzenleyici</div>
        <label class="check" style="margin:0;">
          <input id="autoRenderChk" type="checkbox" checked>
          Otomatik Render
        </label>
      </div>

      <div class="top-actions">
        <button class="btn b1" id="btnRender">GÖRÜNTÜLE</button>
        <button class="btn b2" id="btnClear">TEMİZLE</button>
        <button class="btn b3" id="btnCopy">KOPYALA</button>
        <button class="btn b4" id="btnPng">PNG İNDİR</button>
        <button class="btn b5" id="btnPdf">PDF İNDİR</button>
      </div>

      <div class="body">
        <div class="grid">
          <div class="box">
            <div class="label">Metin</div>
            <textarea id="inputText" placeholder="Metni buraya yapıştırın..."></textarea>

            <div class="status">
              <div class="pill"><span class="dot" id="dotCDN"></span> CDN</div>
              <div class="pill"><span class="dot" id="dotKaTeX"></span> KaTeX</div>
              <div class="pill"><span class="dot" id="dotAuto"></span> AutoRender</div>
              <div class="pill"><span class="dot" id="dotCanvas"></span> html2canvas</div>
              <div class="pill"><span class="dot" id="dotPDF"></span> jsPDF</div>
            </div>
          </div>

          <div class="box">
            <div class="label">Ayarlar</div>

            <div class="row" style="margin-bottom:10px;">
              <div>
                <div class="label" style="margin-top:0;">Yazı tipi</div>
                <select id="fontFamily">
                  <option value="Arial, sans-serif" selected>Arial</option>
                  <option value="Times New Roman, serif">Times New Roman</option>
                  <option value="Georgia, serif">Georgia</option>
                  <option value="Calibri, sans-serif">Calibri</option>
                  <option value="Tahoma, sans-serif">Tahoma</option>
                </select>
              </div>
              <div>
                <div class="label" style="margin-top:0;">Boyut (px)</div>
                <input id="fontSize" type="number" min="12" max="44" value="22" />
              </div>
            </div>

            <div class="row" style="margin-bottom:10px;">
              <div>
                <div class="label" style="margin-top:0;">Metin rengi</div>
                <input id="textColor" type="text" value="#111827" />
              </div>
              <div>
                <div class="label" style="margin-top:0;">Arka plan</div>
                <input id="bgColor" type="text" value="#ffffff" />
              </div>
            </div>

            <div class="row" style="margin-bottom:10px;">
              <div>
                <div class="label" style="margin-top:0;">Hizalama</div>
                <select id="alignSel">
                  <option value="justify" selected>İki yana yasla</option>
                  <option value="left">Sola yasla</option>
                  <option value="center">Ortala</option>
                </select>
              </div>
              <div style="display:flex;align-items:flex-end;gap:10px;">
                <label class="check" style="margin:0;">
                  <input id="boldAuto" type="checkbox" checked>
                  Kalın <small>(otomatik başlıklar)</small>
                </label>
              </div>
            </div>

            <label class="check" style="margin-top:6px;">
              <input id="transparentChk" type="checkbox">
              Şeffaf
            </label>

            <div class="exportHint">
              Şeffaf PNG için: “Şeffaf” açık olsun. Ardından “PNG İNDİR” ile kaydedin.
            </div>

            <div style="height:12px"></div>

            <div class="label">Örnek Şablonlar</div>
            <select id="templateSel">
              <option value="">Seçiniz...</option>
              <option value="t1">7. İnşaat Müh.: Vinç Kolunun Salınımı (cos)</option>
              <option value="t2">6. Otomotiv Müh.: Süspansiyon (sin)</option>
            </select>

            <div style="height:10px"></div>
            <div class="row">
              <button class="btn b3" id="btnTemplateReplace" style="min-width:auto;">Şablonu YERİNE YAZ</button>
              <button class="btn b1" id="btnTemplateAppend" style="min-width:auto;">Şablonu SONA EKLE</button>
            </div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="previewWrap">
          <div class="page" id="pageBox">
            <div id="preview" class="meb justify"></div>
          </div>
        </div>

        <div class="history" id="historyBox" style="display:none;">
          <div class="historyHead">GEÇMİŞ (Son 5)</div>
          <div id="historyList"></div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setStatusDots(){
      const ok = (v) => v ? 'ok' : '';
      $('dotCDN').className = 'dot ok';
      $('dotKaTeX').className  = 'dot ' + ok(!!window.katex);
      $('dotAuto').className   = 'dot ' + ok(!!window.renderMathInElement);
      $('dotCanvas').className = 'dot ' + ok(!!window.html2canvas);
      $('dotPDF').className    = 'dot ' + ok(!!(window.jspdf && window.jspdf.jsPDF));
    }

    function escHTML(s){
      return (s || '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    // --- INLINE: LaTeX -> Unicode (KaTeX'e sokmuyoruz, kırmızı kalmıyor)
    function texInlineToUnicode(s){
      if(!s) return s;

      // derece
      s = s.replace(/\^\s*\\circ\b/g, '°');
      s = s.replace(/\\circ\b/g, '°');

      // greek
      s = s.replace(/\\theta\b/g, 'θ');
      s = s.replace(/\\pi\b/g, 'π');

      // oklar
      s = s.replace(/\\Rightarrow\b/g, '⇒');
      s = s.replace(/\\rightarrow\b/g, '→');

      // trig fonksiyonlar (metinde plain)
      s = s.replace(/\\cos\b/g, 'cos');
      s = s.replace(/\\sin\b/g, 'sin');
      s = s.replace(/\\tan\b/g, 'tan');

      // küçük boşluk komutları
      s = s.replace(/\\,|\\;|\\!/g, ' ');

      // parantez içi: (\theta) gibi kalan escape'leri temizle
      s = s.replace(/\\\(/g, '(').replace(/\\\)/g, ')');

      // artan gereksiz backslash temizliği (çok agresif değil)
      // (Örn: "x(\theta)" yazılmışsa kalmış olabilir)
      return s;
    }

    // Display math satırı: burada KaTeX çalışacak.
    function normalizeDisplayMath(s){
      if(!s) return s;
      // 120\circ -> 120^\circ
      s = s.replace(/(\d)\s*\\circ\b/g, '$1^\\\\circ');
      return s;
    }

    const AUTO_BOLD_LABELS = new Set([
      'Senaryo:', 'Birimler:', 'Soru:', 'Çözüm:', 'Sonuç:',
      'Denklemi kuralım:', 'Sadeleştirelim:',
      'Durum 1:', 'Durum 2:', 'Durum 3:', 'Durum 4:'
    ]);

    function isHeadingLine(line){ return /^#+\s/.test(line.trim()); }

    function buildHTMLFromText(raw){
      const lines = (raw || '').replace(/\r/g,'').split('\n');
      const boldAuto = $('boldAuto').checked;

      let html = '';
      let expectDisplayEq = false;    // Denklemi kuralım: sonraki satır
      let expectDisplayEq2 = false;   // Sadeleştirelim: sonraki satır

      for(let i=0;i<lines.length;i++){
        const orig = lines[i] ?? '';
        let line = orig.trimEnd();

        if(!line.trim()){
          html += `<div class="p"></div>`;
          expectDisplayEq = false;
          expectDisplayEq2 = false;
          continue;
        }

        if(isHeadingLine(line)){
          const t = escHTML(line.replace(/^#+\s*/,'').trim());
          html += `<div class="p" style="font-weight:900;font-size:20px;margin-bottom:12px;">${t}</div>`;
          expectDisplayEq = false;
          expectDisplayEq2 = false;
          continue;
        }

        // Display denklem satırları: sadece burada KaTeX
        if(expectDisplayEq || expectDisplayEq2){
          const clean = normalizeDisplayMath(line.trim());
          html += `<div class="p">$$ ${escHTML(clean)} $$</div>`;
          expectDisplayEq = false;
          expectDisplayEq2 = false;
          continue;
        }

        const colonIdx = line.indexOf(':');
        if(colonIdx>0){
          const label = line.slice(0, colonIdx+1);
          let restRaw = line.slice(colonIdx+1).trim();

          const labelEsc = escHTML(label);
          const labelHTML = (boldAuto && AUTO_BOLD_LABELS.has(label))
            ? `<span class="lbl">${labelEsc}</span>`
            : labelEsc;

          if(label === 'Denklemi kuralım:' && restRaw.length === 0){
            html += `<div class="p">${labelHTML}</div>`;
            expectDisplayEq = true;
            continue;
          }
          if(label === 'Sadeleştirelim:' && restRaw.length === 0){
            html += `<div class="p">${labelHTML}</div>`;
            expectDisplayEq2 = true;
            continue;
          }

          // "Durum 1:" gibi satırlarda matematik cümlesini unicode'a çevir
          restRaw = texInlineToUnicode(restRaw);

          if(label === 'Sonuç:'){
            html += `<div class="p resultLine"><span class="lbl">${labelEsc}</span> ${escHTML(restRaw)}</div>`;
            continue;
          }

          html += `<div class="p">${labelHTML} ${escHTML(restRaw)}</div>`;
          continue;
        }

        // Normal satır: inline unicode dönüşümü uygula
        line = texInlineToUnicode(line);
        html += `<div class="p">${escHTML(line)}</div>`;
      }

      return html;
    }

    function applyPreviewStyles(){
      const preview = $('preview');
      preview.style.fontFamily = $('fontFamily').value;
      preview.style.fontSize = `${parseInt($('fontSize').value || '22',10)}px`;
      preview.style.color = $('textColor').value || '#111827';

      const bg = $('transparentChk').checked ? 'transparent' : ($('bgColor').value || '#ffffff');
      $('pageBox').style.background = bg;

      preview.classList.remove('justify','left','center');
      preview.classList.add($('alignSel').value);
    }

    function render(){
      const raw = $('inputText').value || '';
      $('preview').innerHTML = buildHTMLFromText(raw);
      applyPreviewStyles();

      // SADECE $$...$$ olan display denklemleri render et
      if($('autoRenderChk').checked && window.renderMathInElement){
        window.renderMathInElement($('preview'), {
          delimiters: [
            {left: "$$", right: "$$", display: true}
          ],
          throwOnError: false
        });
      }
    }

    // --- Geçmiş
    const HISTORY_KEY = 'math_editor_history_v6';
    function loadHistory(){
      try{ const a = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); return Array.isArray(a)?a:[]; }
      catch(e){ return []; }
    }
    function saveHistory(raw){
      if(!raw.trim()) return;
      const arr = loadHistory().filter(x => x !== raw);
      arr.unshift(raw);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0,5)));
      drawHistory();
    }
    function drawHistory(){
      const arr = loadHistory();
      const box = $('historyBox');
      const list = $('historyList');
      if(!arr.length){ box.style.display='none'; list.innerHTML=''; return; }
      box.style.display='block';
      list.innerHTML = arr.map((t, idx) => {
        const first = (t.split('\n').find(x=>x.trim()) || '').trim();
        const snip = first.length>90 ? first.slice(0,90)+'…' : first;
        return `<div class="historyItem" data-idx="${idx}"><b>#${idx+1}</b><small>${escHTML(snip)}</small></div>`;
      }).join('');
      [...list.querySelectorAll('.historyItem')].forEach(el=>{
        el.addEventListener('click', ()=>{
          const i = parseInt(el.getAttribute('data-idx'),10);
          $('inputText').value = loadHistory()[i] || '';
          render();
        });
      });
    }

    async function exportPNG(){
      render();
      const page = $('pageBox');
      const transparent = $('transparentChk').checked;
      const canvas = await window.html2canvas(page, {
        backgroundColor: transparent ? null : ($('bgColor').value || '#ffffff'),
        scale: 2
      });
      const a = document.createElement('a');
      a.download = 'matematik.png';
      a.href = canvas.toDataURL('image/png');
      a.click();
    }

    async function exportPDF(){
      render();
      const page = $('pageBox');
      const canvas = await window.html2canvas(page, { backgroundColor:'#ffffff', scale:2 });
      const img = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:'p', unit:'mm', format:'a4' });

      const pageWidth = 210, pageHeight = 297;
      const props = pdf.getImageProperties(img);
      const ratio = props.width / props.height;

      let w = pageWidth - 20;
      let h = w / ratio;
      if(h > pageHeight - 20){ h = pageHeight - 20; w = h * ratio; }
      const x = (pageWidth - w)/2;
      const y = 10;

      pdf.addImage(img,'PNG',x,y,w,h);
      pdf.save('matematik.pdf');
    }

    const TEMPLATES = {
      t1: `## 7. İnşaat Mühendisliği: Vinç Kolunun Salınımı
Senaryo: Rüzgarlı bir havada bir kule vincin ucundaki yükün denge noktasından yatay uzaklığı (x), açısına (\\theta) bağlı olarak x(\\theta) = 2 \\cos(3\\theta^\\circ + 30^\\circ) metre olarak ölçülmüştür.
Birimler: x (Metre - m), \\theta (Derece - ^\\circ).
Soru: [0, 120^\\circ] açı aralığında, yükün denge noktasından tam 1 metre sağda (x = 1) olduğu kaç farklı açı değeri vardır?
Çözüm:
Denklemi kuralım:
2\\cos(3\\theta + 30^\\circ) = 1
Sadeleştirelim:
\\cos(3\\theta + 30^\\circ) = \\frac{1}{2}
Durum 1: 3\\theta + 30^\\circ = 60^\\circ \\Rightarrow \\theta_1 = 10^\\circ
Durum 2: 3\\theta + 30^\\circ = 300^\\circ \\Rightarrow \\theta_2 = 90^\\circ
Sonuç: Vincin yükü 2 farklı açıda denge noktasından 1 metre uzaktadır.`,

      t2: `## 6. Otomotiv Mühendisliği: Süspansiyon Sistemi
Senaryo: Bir aracın tümseğe girdikten sonraki dikey salınımı, zamana bağlı olarak y(t) = 5\\sqrt{2}\\,\\sin(4t^\\circ) denklemiyle modellenmiştir.
Birimler: y (cm), t (s).
Soru: [0, 90^\\circ] saniye aralığında, y(t) = -5 olduğu kaç farklı an vardır?
Çözüm:
Denklemi kuralım:
5\\sqrt{2}\\sin(4t) = -5
Sadeleştirelim:
\\sin(4t) = -\\frac{\\sqrt{2}}{2}
Sonuç: Belirtilen aralıkta 2 farklı zamanda sağlanır.`
    };

    function getSelectedTemplateText(){
      const k = $('templateSel').value;
      return k ? (TEMPLATES[k] || '') : '';
    }

    window.addEventListener('load', ()=>{
      setStatusDots();
      drawHistory();
      render();
    });

    $('btnRender').addEventListener('click', ()=>{
      render();
      saveHistory($('inputText').value || '');
    });
    $('btnClear').addEventListener('click', ()=>{ $('inputText').value=''; render(); });
    $('btnCopy').addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText($('inputText').value || ''); alert('Metin kopyalandı.'); }
      catch(e){ alert('Kopyalama başarısız. Tarayıcı izin vermedi.'); }
    });
    $('btnPng').addEventListener('click', async ()=>{
      if(!window.html2canvas){ alert('html2canvas yüklenmedi.'); return; }
      await exportPNG();
    });
    $('btnPdf').addEventListener('click', async ()=>{
      if(!(window.jspdf && window.jspdf.jsPDF)){ alert('jsPDF yüklenmedi.'); return; }
      await exportPDF();
    });

    $('btnTemplateReplace').addEventListener('click', ()=>{
      const t = getSelectedTemplateText();
      if(!t){ alert('Lütfen bir şablon seçin.'); return; }
      $('inputText').value = t;
      render();
    });
    $('btnTemplateAppend').addEventListener('click', ()=>{
      const t = getSelectedTemplateText();
      if(!t){ alert('Lütfen bir şablon seçin.'); return; }
      const cur = $('inputText').value || '';
      $('inputText').value = cur.trim() ? (cur.trimEnd() + "\n\n" + t) : t;
      render();
    });

    ['fontFamily','fontSize','textColor','bgColor','alignSel','boldAuto','transparentChk','autoRenderChk']
      .forEach(id => $(id).addEventListener('change', render));

    let tmr=null;
    $('inputText').addEventListener('input', ()=>{
      if(!$('autoRenderChk').checked) return;
      clearTimeout(tmr);
      tmr=setTimeout(render,200);
    });
  </script>
</body>
</html>
