<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Matematiksel Metin DÃ¼zenleyici</title>

  <!-- KaTeX (Online) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <!-- html2canvas + jsPDF (Online) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg1:#5b2cff;
      --bg2:#6a7bff;
      --card:#ffffff;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow: 0 12px 40px rgba(0,0,0,.18);
      --radius: 18px;

      --btn1:#5865f2;
      --btn2:#ff5ca8;
      --btn3:#00b3ff;
      --btn4:#ffb100;
      --btn5:#6d28d9;

      --warnBg:#fff7e6;
      --warnBorder:#f59e0b;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      padding: 20px 14px 24px;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
    }

    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .header{
      padding: 18px 20px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid var(--border);
    }

    .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight: 800;
      font-size: 22px;
    }

    .tog{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:600;
      color: var(--muted);
      user-select:none;
    }
    .tog input{ transform: scale(1.15); }

    .content{
      padding: 14px 18px 18px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .label{
      font-size: 12px;
      font-weight: 800;
      letter-spacing:.06em;
      color: var(--muted);
      margin-bottom:6px;
    }

    select, input[type="number"], input[type="text"], textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 16px;
      outline:none;
    }
    textarea{
      min-height: 130px;
      resize: vertical;
      line-height: 1.35;
    }

    .controls{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }

    .ctrl{
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius: 14px;
      padding:12px;
    }

    .ctrl .label{ margin-bottom:8px; }

    .inline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .colorbtn{
      width:44px;
      height:36px;
      border-radius: 10px;
      border:1px solid var(--border);
      background:#111827;
      cursor:pointer;
    }

    .checkbox{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      color:var(--text);
      user-select:none;
    }
    .checkbox input{ transform: scale(1.15); }

    .btns{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .btn{
      border:none;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 900;
      letter-spacing:.02em;
      color:white;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      font-size: 15px;
    }
    .btn:active{ transform: translateY(1px); }

    .b1{ background: linear-gradient(90deg, var(--btn1), #7c3aed); }
    .b2{ background: linear-gradient(90deg, var(--btn2), #fb7185); }
    .b3{ background: linear-gradient(90deg, var(--btn3), #22c55e); }
    .b4{ background: linear-gradient(90deg, var(--btn4), #f97316); color:#1f2937; }
    .b5{ background: linear-gradient(90deg, var(--btn5), #8b5cf6); }

    .hint{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 2px solid var(--warnBorder);
      background: var(--warnBg);
      font-weight: 700;
      color:#7c2d12;
      font-size: 14px;
    }

    /* Preview */
    .previewWrap{
      margin-top: 12px;
      border: 2px dashed #cbd5e1;
      border-radius: 16px;
      padding: 14px;
      background:#ffffff;
    }

    /* MEB/Ã–SYM uyumlu paragraf stili */
    .preview{
      white-space: normal;            /* satÄ±rlarÄ± dÃ¼zenli kÄ±r */
      word-break: break-word;
      line-height: 1.65;              /* okunabilir */
      font-size: 22px;                /* varsayÄ±lan, UIâ€™dan deÄŸiÅŸir */
      color:#111827;
      text-align: justify;            /* iki yana yasla */
      text-justify: inter-word;
      font-family: Arial, sans-serif; /* varsayÄ±lan, UIâ€™dan deÄŸiÅŸir */
      padding: 2px 4px;
    }

    /* KaTeX gÃ¶rÃ¼nÃ¼m incelikleri */
    .preview .katex{ font-size: 1em; }
    .preview .katex-display{
      margin: 10px 0 14px;
    }

    .history{
      margin-top: 14px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }
    .history h3{
      margin:0 0 10px;
      font-size: 14px;
      color: var(--muted);
      letter-spacing:.02em;
    }
    .histItem{
      background:#f8fafc;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 8px;
      font-size: 14px;
      color:#111827;
      cursor:pointer;
    }
    .histItem:hover{ background:#eef2ff; }

    .small{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      line-height:1.35;
    }

    @media (max-width: 820px){
      .controls{ grid-template-columns: 1fr; }
      .btns{ grid-template-columns: 1fr; }
      .title{ font-size: 20px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="title">ğŸ“˜ Matematiksel Metin DÃ¼zenleyici</div>
        <label class="tog">
          <input id="autoRender" type="checkbox">
          Otomatik Render
        </label>
      </div>

      <div class="content">
        <div class="row">
          <div>
            <div class="label">METÄ°N</div>
            <textarea id="input" placeholder="Metninizi buraya yapÄ±ÅŸtÄ±rÄ±n..."></textarea>
            <div class="small">
              Ä°pucu: LaTeX komutlarÄ± \sqrt{2}, \frac{a}{b}, \sin(x), \begin{pmatrix}...\end{pmatrix} gibi yazÄ±labilir.
              Derece iÃ§in <b>^\circ</b> yazabilir veya pratik olarak <b>^Â°</b> (Ã¶r. 225^Â°) yazabilirsiniz â€” otomatik dÃ¼zeltilir.
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="ctrl">
            <div class="label">YAZI TÄ°PÄ°</div>
            <select id="fontFamily">
              <option value="Arial" selected>Arial</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Calibri">Calibri</option>
              <option value="Georgia">Georgia</option>
              <option value="Verdana">Verdana</option>
            </select>
          </div>

          <div class="ctrl">
            <div class="label">BOYUT (px)</div>
            <input id="fontSize" type="number" min="12" max="64" value="22" />
          </div>

          <div class="ctrl">
            <div class="label">METÄ°N RENGÄ°</div>
            <div class="inline">
              <button id="textColorBtn" class="colorbtn" type="button" aria-label="Metin rengi"></button>
              <input id="textColor" type="text" value="#111827" />
            </div>
          </div>

          <div class="ctrl">
            <div class="label">ARKA PLAN</div>
            <div class="inline">
              <button id="bgColorBtn" class="colorbtn" type="button" aria-label="Arka plan rengi" style="background:#ffffff"></button>
              <input id="bgColor" type="text" value="#ffffff" />
            </div>
            <div style="margin-top:10px">
              <label class="checkbox">
                <input id="transparent" type="checkbox" checked>
                Åeffaf
              </label>
              <div class="small">Åeffaf aÃ§Ä±kken PNG arka planÄ± transparan olur.</div>
            </div>
          </div>

          <div class="ctrl">
            <div class="label">HÄ°ZALAMA</div>
            <select id="align">
              <option value="left">Sola</option>
              <option value="center">Ortala</option>
              <option value="right">SaÄŸa</option>
              <option value="justify" selected>Ä°ki yana yasla</option>
            </select>
            <div class="small">Ä°ki yana yasla (justify) MEB/Ã–SYM metin dÃ¼zeni iÃ§in Ã¶nerilir.</div>
          </div>

          <div class="ctrl">
            <div class="label">STÄ°L</div>
            <label class="checkbox">
              <input id="boldStyle" type="checkbox" checked>
              KalÄ±n (otomatik baÅŸlÄ±klar)
            </label>
            <div class="small">
              â€œDenklemi kuralÄ±m:â€ ve â€œSonuÃ§:â€ satÄ±rlarÄ± otomatik kalÄ±nlaÅŸÄ±r.
              â€œDenklemi kuralÄ±m:â€ satÄ±rÄ±ndan sonraki <b>tek denklem satÄ±rÄ±</b> otomatik blok (display) yapÄ±lÄ±r.
            </div>
          </div>
        </div>

        <div class="btns">
          <button class="btn b1" id="btnRender" type="button">GÃ–RÃœNTÃœLE</button>
          <button class="btn b2" id="btnClear" type="button">TEMÄ°ZLE</button>
          <button class="btn b3" id="btnCopy" type="button">KOPYALA</button>
          <button class="btn b4" id="btnPng" type="button">PNG Ä°NDÄ°R</button>
          <button class="btn b5" id="btnPdf" type="button">PDF Ä°NDÄ°R</button>
        </div>

        <div class="hint">
          Åeffaf PNG iÃ§in: â€œÅeffafâ€ seÃ§eneÄŸi aÃ§Ä±k olsun. ArdÄ±ndan â€œPNG Ä°NDÄ°Râ€ ile kaydedin.
        </div>

        <div class="previewWrap" id="captureArea">
          <div id="preview" class="preview"></div>
        </div>

        <div class="history">
          <h3>GEÃ‡MÄ°Å (Son 5)</h3>
          <div id="history"></div>
        </div>

      </div>
    </div>
  </div>

<script>
(function(){
  const elInput = document.getElementById('input');
  const elPreview = document.getElementById('preview');
  const elHistory = document.getElementById('history');

  const elAuto = document.getElementById('autoRender');
  const elTransparent = document.getElementById('transparent');
  const elAlign = document.getElementById('align');
  const elFontFamily = document.getElementById('fontFamily');
  const elFontSize = document.getElementById('fontSize');
  const elTextColor = document.getElementById('textColor');
  const elBgColor = document.getElementById('bgColor');
  const elBoldStyle = document.getElementById('boldStyle');

  const btnRender = document.getElementById('btnRender');
  const btnClear = document.getElementById('btnClear');
  const btnCopy = document.getElementById('btnCopy');
  const btnPng = document.getElementById('btnPng');
  const btnPdf = document.getElementById('btnPdf');

  const textColorBtn = document.getElementById('textColorBtn');
  const bgColorBtn = document.getElementById('bgColorBtn');

  // Otomatik render ilk aÃ§Ä±lÄ±ÅŸta kapalÄ±
  elAuto.checked = false;

  // Ä°lk manuel "GÃ–RÃœNTÃœLE" sonrasÄ± auto render kalÄ±cÄ± olsun (sayfa kapanana kadar)
  let autoArmed = false;

  // Basit geÃ§miÅŸ (son 5)
  const HISTORY_KEY = 'math_editor_history_v2';
  function loadHistory(){
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); }
    catch { return []; }
  }
  function saveHistory(list){
    localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0,5)));
  }
  function pushHistory(text){
    const t = (text || '').trim();
    if(!t) return;
    const list = loadHistory();
    const filtered = list.filter(x => x !== t);
    filtered.unshift(t);
    saveHistory(filtered);
    renderHistory();
  }
  function renderHistory(){
    const list = loadHistory();
    elHistory.innerHTML = '';
    list.forEach((t) => {
      const div = document.createElement('div');
      div.className = 'histItem';
      div.textContent = t.length > 140 ? (t.slice(0,140)+'â€¦') : t;
      div.title = 'TÄ±kla: metne geri yÃ¼kle';
      div.onclick = () => { elInput.value = t; triggerMaybeAuto(); };
      elHistory.appendChild(div);
    });
  }

  // Renk butonlarÄ± (basit: input'a tÄ±klat)
  function syncColorButtons(){
    textColorBtn.style.background = elTextColor.value || '#111827';
    bgColorBtn.style.background = elBgColor.value || '#ffffff';
  }
  syncColorButtons();

  // UI stilleri preview'a uygula
  function applyPreviewStyles(){
    elPreview.style.fontFamily = elFontFamily.value;
    elPreview.style.fontSize = (parseInt(elFontSize.value || '22',10)) + 'px';
    elPreview.style.color = elTextColor.value || '#111827';

    // hizalama
    const a = elAlign.value || 'justify';
    elPreview.style.textAlign = a;
    if(a === 'justify'){
      elPreview.style.textJustify = 'inter-word';
    }else{
      elPreview.style.textJustify = 'auto';
    }

    // arka plan / ÅŸeffaf
    const cap = document.getElementById('captureArea');
    if(elTransparent.checked){
      cap.style.background = 'transparent';
      cap.style.borderColor = '#cbd5e1';
    }else{
      cap.style.background = (elBgColor.value || '#ffffff');
      cap.style.borderColor = '#cbd5e1';
    }
  }

  // --- METÄ°N -> HTML + KaTeX ---
  // AmaÃ§:
  // 1) BaÅŸlÄ±k satÄ±rlarÄ±nÄ± bold
  // 2) "Denklemi kuralÄ±m:" satÄ±rÄ±ndan sonraki tek denklem satÄ±rÄ±nÄ± display math yap
  // 3) Inline LaTeX (\sqrt, \frac, \sin...) yakala ve \( ... \)
  // 4) base^Â° (225^Â°, 4t^Â°) dÃ¼zelt ve math'e al
  // 5) SatÄ±r sonlarÄ±nÄ± paragraf dÃ¼zenine Ã§evir

  const BOLD_LABELS = [
    'Denklemi kuralÄ±m:',
    'SonuÃ§:',
    'Ã‡Ã¶zÃ¼m:',
    'Senaryo:',
    'Birimler:',
    'Soru:'
  ];

  function escapeHtml(s){
    return (s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  }

  function normalizeText(raw){
    // NBSP vb. temizle
    let t = (raw || '')
      .replace(/\r\n/g, '\n')
      .replace(/\r/g, '\n')
      .replace(/\u00A0/g,' ')
      .replace(/[ \t]+\n/g, '\n')
      .trim();
    return t;
  }

  function isLikelyEquationLine(line){
    // Ã‡ok kaba ama pratik: LaTeX komutu, =, \frac, \sqrt, \sin vb. varsa denklem say
    const s = line.trim();
    if(!s) return false;
    if(/\\(frac|sqrt|sin|cos|tan|cot|log|ln|pi|theta|begin|end|cdot|times|implies|Rightarrow)/.test(s)) return true;
    if(/[=]/.test(s)) return true;
    if(/\^Â°/.test(s)) return true;
    if(/\^\s*\\circ/.test(s)) return true;
    if(/[0-9A-Za-z]\s*\^\s*\{?\\circ\}?/.test(s)) return true;
    return false;
  }

  function fixDegreeNotation(line){
    // base^Â°  --> base^{\circ}
    // Ã¶r: 225^Â° , 4t^Â° , x1^Â°
    let s = line;

    // 1) base ^ Â° (Â° tek karakter)
    s = s.replace(/(\b[0-9A-Za-z]+)\s*\^\s*Â°/g, "$1^{\\\\circ}");

    // 2) base ^ \circ
    s = s.replace(/(\b[0-9A-Za-z]+)\s*\^\s*\\circ/g, "$1^{\\\\circ}");

    return s;
  }

  function wrapInlineLatexSegments(line){
    // Burada hedef: metin iÃ§inde \sqrt{2} gibi komutlarÄ± inline math'e al.
    // AyrÄ±ca "base^{\circ}" gibi dereceli ifadeler zaten LaTeX oldu; bunu da inline math'e al.
    let s = (line || '');

    // Derece dÃ¶nÃ¼ÅŸÃ¼mÃ¼nÃ¼ Ã¶nce yap
    s = fixDegreeNotation(s);

    // 1) EÄŸer line iÃ§inde zaten \( ... \) veya \[ ... \] varsa dokunma (basitÃ§e bÄ±rakÄ±yoruz)
    // 2) \begin{...} varsa satÄ±r tamamen denklem gibi ele alÄ±nacak, burada inline'a sokmuyoruz

    if(/\\begin\{/.test(s)) return s;

    // Inline LaTeX: \komut... iÃ§eren parÃ§alarÄ± \( ... \) iÃ§ine al
    // Basit yaklaÅŸÄ±m: satÄ±rda \ ile baÅŸlayan komut varsa ve satÄ±r tamamÄ± denklem deÄŸilse,
    // satÄ±r iÃ§indeki tÃ¼m \komut parÃ§alarÄ±nÄ± math'e almak yerine satÄ±rdaki "latex kokan" kÄ±sÄ±mlarÄ± inline math'e alÄ±yoruz.
    //
    // Daha gÃ¼venli: satÄ±rda herhangi bir \komut varsa ve satÄ±rÄ±n kendisi tamamen dÃ¼z metinse, tÃ¼m satÄ±rÄ± inline math yapma.
    // Bunun yerine, \komut iÃ§eren tokenlarÄ± yakalamaya Ã§alÄ±ÅŸ:
    //
    // Pratik: satÄ±rda \frac{...}{...} veya \sqrt{...} gibi yapÄ±lar varsa bunlarÄ± \( ... \) iÃ§ine al
    // ve gerisini normal bÄ±rak.

    // \frac{...}{...}
    s = s.replace(/\\frac\{[^}]+\}\{[^}]+\}/g, (m)=>"\\\\("+m+"\\\\)");
    // \sqrt{...}
    s = s.replace(/\\sqrt\{[^}]+\}/g, (m)=>"\\\\("+m+"\\\\)");
    // trig/log
    s = s.replace(/\\(sin|cos|tan|cot|log|ln)\s*\([^)]*\)/g, (m)=>"\\\\("+m+"\\\\)");
    // \cdot, \times gibi semboller tek baÅŸÄ±na kaldÄ±ysa Ã§evresini almak iÃ§in: "a \cdot b" kalÄ±bÄ±
    s = s.replace(/([0-9A-Za-z\)\}]+)\s*(\\cdot|\\times)\s*([0-9A-Za-z\(\\\{]+)/g, (m)=>"\\\\("+m+"\\\\)");
    // base^{\circ} derecelerini math'e al (Ã¶r: 225^{\circ})
    s = s.replace(/(\b[0-9A-Za-z]+)\^\{\\circ\}/g, (m)=>"\\\\("+m+"\\\\)");

    return s;
  }

  function formatToHtml(raw){
    const t = normalizeText(raw);
    if(!t){
      return '';
    }

    const lines = t.split('\n');

    let htmlParts = [];
    let i=0;

    while(i < lines.length){
      let line = lines[i] || '';
      const trimmed = line.trim();

      // boÅŸ satÄ±r -> paragraf aralÄ±ÄŸÄ±
      if(!trimmed){
        htmlParts.push('<div style="height:12px"></div>');
        i++;
        continue;
      }

      // Otomatik kalÄ±n baÅŸlÄ±klar
      const boldOn = !!elBoldStyle.checked;

      const isBoldLabel = boldOn && BOLD_LABELS.some(lbl => trimmed.startsWith(lbl));

      // "Denklemi kuralÄ±m:" Ã¶zel kural:
      // Bu satÄ±r kalÄ±n + bir sonraki satÄ±r denklemse, onu blok (display) yap.
      if(boldOn && trimmed.startsWith('Denklemi kuralÄ±m:')){
        // baÅŸlÄ±k satÄ±rÄ±
        htmlParts.push(`<div><b>${escapeHtml('Denklemi kuralÄ±m:')}</b></div>`);

        // aynÄ± satÄ±rda denklem varsa (Denklemi kuralÄ±m: ... )
        const after = trimmed.replace(/^Denklemi kuralÄ±m:\s*/,'').trim();
        if(after){
          // denklemi blok yap
          const eq = fixDegreeNotation(after);
          htmlParts.push(`<div>\\[${escapeHtml(eq)}\\]</div>`);
          i++;
          continue;
        }

        // sonraki satÄ±r denklem mi?
        const next = (lines[i+1] || '').trim();
        if(next && isLikelyEquationLine(next)){
          const eq = fixDegreeNotation(next);
          htmlParts.push(`<div>\\[${escapeHtml(eq)}\\]</div>`);
          i += 2;
          continue;
        }

        i++;
        continue;
      }

      // "SonuÃ§:" satÄ±rÄ±nÄ± otomatik bold (satÄ±rÄ±n tamamÄ±)
      if(boldOn && trimmed.startsWith('SonuÃ§:')){
        // "SonuÃ§:" kelimesi bold, devamÄ± normal ama satÄ±r genelinde gÃ¼Ã§lÃ¼ gÃ¶rÃ¼nsÃ¼n diye tÃ¼m satÄ±rÄ± bold veriyoruz
        htmlParts.push(`<div><b>${escapeHtml(trimmed)}</b></div>`);
        i++;
        continue;
      }

      // DiÄŸer etiketler: Senaryo/Birimler/Soru/Ã‡Ã¶zÃ¼m...
      if(isBoldLabel){
        // "Etiket: ..." ÅŸeklinde ise etiketi bold yap, devamÄ± normal
        const idx = trimmed.indexOf(':');
        const left = trimmed.slice(0, idx+1);
        const right = trimmed.slice(idx+1).trim();

        let rightProcessed = wrapInlineLatexSegments(right);
        htmlParts.push(
          `<div><b>${escapeHtml(left)}</b> ${escapeHtml(rightProcessed)}</div>`
            // escapeHtml rightProcessed iÃ§indeki \( \) kaÃ§acak, bunu dÃ¼zeltmek iÃ§in aÅŸaÄŸÄ±da render Ã¶ncesi geri alacaÄŸÄ±z
        );
        i++;
        continue;
      }

      // Normal satÄ±r: inline latex dÃ¼zeltmeleri uygula
      const processed = wrapInlineLatexSegments(trimmed);
      // HTML kaÃ§Ä±ÅŸÄ±: fakat \( \) ve \[ \] backslash'larÄ± kaybolmasÄ±n diye geÃ§ici placeholder kullanacaÄŸÄ±z
      const ph = processed
        .replace(/\\\\\(/g,'@@LP@@')
        .replace(/\\\\\)/g,'@@RP@@')
        .replace(/\\\\\[/g,'@@LB@@')
        .replace(/\\\\\]/g,'@@RB@@');

      const esc = escapeHtml(ph)
        .replace(/@@LP@@/g,'\\(')
        .replace(/@@RP@@/g,'\\)')
        .replace(/@@LB@@/g,'\\[')
        .replace(/@@RB@@/g,'\\]');

      htmlParts.push(`<div>${esc}</div>`);
      i++;
    }

    return htmlParts.join('');
  }

  function render(){
    applyPreviewStyles();

    const raw = elInput.value || '';
    const html = formatToHtml(raw);
    elPreview.innerHTML = html;

    // KaTeX render
    // auto-render yÃ¼klÃ¼ deÄŸilse sessiz geÃ§
    if(window.renderMathInElement){
      try{
        window.renderMathInElement(elPreview, {
          delimiters: [
            {left: "\\[", right: "\\]", display: true},
            {left: "\\(", right: "\\)", display: false},
          ],
          throwOnError: false
        });
      }catch(e){
        // render hatasÄ± olursa metni bozmayalÄ±m
        console.warn(e);
      }
    }

    // geÃ§miÅŸe ekle
    pushHistory(raw);
  }

  function triggerMaybeAuto(){
    if(elAuto.checked && autoArmed){
      // kÃ¼Ã§Ã¼k debounce
      clearTimeout(triggerMaybeAuto._t);
      triggerMaybeAuto._t = setTimeout(render, 120);
    }
  }

  // --- Events ---
  btnRender.addEventListener('click', () => {
    // Ä°lk manual render -> autoArmed ON
    autoArmed = true;

    // KullanÄ±cÄ± isterse checkbox'Ä± sonradan aÃ§abilir; ama biz ilk renderdan sonra otomatik Ã§alÄ±ÅŸmayÄ± Ã¶neriyoruz:
    // EÄŸer kullanÄ±cÄ± checkbox kapalÄ± bÄ±raktÄ±ysa, yine de "yazdÄ±kÃ§a otomatik" iÃ§in checkbox'Ä± otomatik aÃ§mayalÄ±m.
    // Sadece: kullanÄ±cÄ± checkbox'Ä± aÃ§arsa artÄ±k otomatik Ã§alÄ±ÅŸÄ±r.
    render();
  });

  btnClear.addEventListener('click', () => {
    elInput.value = '';
    elPreview.innerHTML = '';
    triggerMaybeAuto();
  });

  btnCopy.addEventListener('click', async () => {
    const txt = elInput.value || '';
    try{
      await navigator.clipboard.writeText(txt);
      alert('Metin panoya kopyalandÄ±.');
    }catch{
      // fallback
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      alert('Metin panoya kopyalandÄ±.');
    }
  });

  // PNG
  btnPng.addEventListener('click', async () => {
    applyPreviewStyles();
    if(!window.html2canvas){
      alert('html2canvas yÃ¼klenemedi. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
      return;
    }
    const cap = document.getElementById('captureArea');

    const bg = elTransparent.checked ? null : (elBgColor.value || '#ffffff');

    const canvas = await html2canvas(cap, {
      backgroundColor: bg,
      scale: 2,
      useCORS: true
    });

    const a = document.createElement('a');
    a.download = 'matematik.png';
    a.href = canvas.toDataURL('image/png');
    a.click();
  });

  // PDF
  btnPdf.addEventListener('click', async () => {
    applyPreviewStyles();
    if(!window.html2canvas){
      alert('html2canvas yÃ¼klenemedi. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
      return;
    }
    const cap = document.getElementById('captureArea');

    const bg = elTransparent.checked ? '#ffffff' : (elBgColor.value || '#ffffff');

    const canvas = await html2canvas(cap, {
      backgroundColor: bg,
      scale: 2,
      useCORS: true
    });

    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF){
      alert('jsPDF yÃ¼klenemedi. Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
      return;
    }

    const pdf = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });

    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    // GÃ¶rseli sayfaya sÄ±ÄŸdÄ±r
    const imgW = canvas.width;
    const imgH = canvas.height;

    const ratio = Math.min((pageWidth - 56) / imgW, (pageHeight - 56) / imgH);
    const w = imgW * ratio;
    const h = imgH * ratio;
    const x = (pageWidth - w) / 2;
    const y = 28;

    pdf.addImage(imgData, 'PNG', x, y, w, h);
    pdf.save('matematik.pdf');
  });

  // Stil deÄŸiÅŸince
  [elAlign, elFontFamily, elFontSize, elTextColor, elBgColor, elTransparent, elBoldStyle].forEach((x)=>{
    x.addEventListener('change', () => {
      syncColorButtons();
      applyPreviewStyles();
      triggerMaybeAuto();
    });
  });

  // Yazarken
  elInput.addEventListener('input', triggerMaybeAuto);

  // Auto checkbox
  elAuto.addEventListener('change', () => {
    if(elAuto.checked && autoArmed){
      render();
    }
  });

  // baÅŸlangÄ±Ã§
  applyPreviewStyles();
  renderHistory();

  // Buton renk input sync
  textColorBtn.addEventListener('click', () => {
    const c = prompt('Metin rengi (hex) Ã¶r: #111827', elTextColor.value || '#111827');
    if(c){ elTextColor.value = c.trim(); syncColorButtons(); applyPreviewStyles(); triggerMaybeAuto(); }
  });
  bgColorBtn.addEventListener('click', () => {
    const c = prompt('Arka plan rengi (hex) Ã¶r: #ffffff', elBgColor.value || '#ffffff');
    if(c){ elBgColor.value = c.trim(); syncColorButtons(); applyPreviewStyles(); triggerMaybeAuto(); }
  });

})();
</script>

</body>
</html>
