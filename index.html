<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematik Render ve Stil Düzenleyici</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: #eceff1; padding: 20px; color: #333; }
        .container { max-width: 850px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        h3 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        
        textarea { 
            width: 100%; height: 120px; border: 2px solid #cbd5e0; border-radius: 10px; 
            padding: 15px; font-size: 15px; box-sizing: border-box; outline: none; transition: 0.2s;
            font-family: 'Courier New', monospace;
        }
        textarea:focus { border-color: #3498db; }
        
        .toolbar { 
            margin: 20px 0; display: flex; flex-wrap: wrap; gap: 20px; 
            background: #f8fafc; padding: 15px; border-radius: 10px; align-items: center;
        }
        
        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; font-weight: bold; color: #64748b; text-transform: uppercase; }

        #preview { 
            margin-top: 20px; padding: 25px; border: 2px dashed #cbd5e0; 
            background: #fff; min-height: 150px; border-radius: 10px;
            line-height: 1.8; overflow-x: auto;
        }

        button { 
            background: #3498db; color: white; border: none; padding: 12px 30px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;
            transition: 0.3s;
        }
        button:hover { background: #2980b9; transform: translateY(-2px); }
        
        .download-btn {
            background: #27ae60;
        }
        .download-btn:hover {
            background: #229954;
        }
        
        /* Matematiksel ifadelerin kalınlığı için özel ayar */
        .bold-mode .katex { font-weight: bold !important; }
        
        /* Hizalama stilleri */
        .align-left { text-align: left; }
        .align-center { text-align: center; }
        .align-right { text-align: right; }
        .align-justify { text-align: justify; }
    </style>
</head>
<body>

<div class="container">
    <h3>Matematiksel Metin Düzenleyici</h3>
    
    <textarea id="inputArea" placeholder="Örn: Y(v) = \frac{v}{20} + 10"></textarea>

    <div class="toolbar">
        <div class="control-group">
            <label>Yazı Tipi</label>
            <select id="fontSelect" onchange="stiliUygula()">
                <option value="'Times New Roman', serif">Times New Roman (Klasik)</option>
                <option value="Arial, sans-serif" selected>Arial (Modern)</option>
                <option value="'Georgia', serif">Georgia</option>
            </select>
        </div>

        <div class="control-group">
            <label>Boyut (px)</label>
            <input type="number" id="sizeInput" value="16" style="width: 60px; padding: 5px;" onchange="stiliUygula()">
        </div>

        <div class="control-group">
            <label>Stil</label>
            <label style="cursor:pointer; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="boldCheck" onchange="stiliUygula()"> <b>KALIN (BOLD)</b>
            </label>
        </div>

        <div class="control-group">
            <label>Hizalama</label>
            <select id="alignSelect" onchange="stiliUygula()">
                <option value="left">Sola Yasla</option>
                <option value="center">Ortala</option>
                <option value="right">Sağa Yasla</option>
                <option value="justify">İki Yana Yasla</option>
            </select>
        </div>

        <button onclick="islemYap()">GÖRÜNTÜLE</button>
        <button class="download-btn" onclick="pngIndir()">PNG İNDİR</button>
    </div>

    <div id="preview">
        Yapıştırdığınız metin burada işlenmiş olarak görünecek...
    </div>
</div>

<script>
    function stiliUygula() {
        const preview = document.getElementById('preview');
        preview.style.fontFamily = document.getElementById('fontSelect').value;
        preview.style.fontSize = document.getElementById('sizeInput').value + "px";
        
        if (document.getElementById('boldCheck').checked) {
            preview.classList.add('bold-mode');
            preview.style.fontWeight = "bold";
        } else {
            preview.classList.remove('bold-mode');
            preview.style.fontWeight = "normal";
        }
        
        // Hizalama uygula
        const align = document.getElementById('alignSelect').value;
        preview.className = preview.className.replace(/align-\w+/g, '');
        if (document.getElementById('boldCheck').checked) {
            preview.classList.add('bold-mode');
        }
        preview.classList.add('align-' + align);
    }

    function islemYap() {
        let text = document.getElementById('inputArea').value;
        const preview = document.getElementById('preview');

        // AKILLI DÜZELTME 1: circC ve benzer desteklenmeyen komutları düzelt
        text = text.replace(/\^\s*\\circC/g, '°C');
        text = text.replace(/\\circC/g, '°C');
        text = text.replace(/\\circ\s*C/g, '°C');
        text = text.replace(/\^\s*°C/g, '°C');
        
        // AKILLI DÜZELTME 2: x^2, x^3 gibi üslü ifadeleri LaTeX formatına çevir
        text = text.replace(/([a-zA-Z])(\^)(\d+)/g, '$$$1^{$3}$$');
        text = text.replace(/([a-zA-Z])(\^)(\([^)]+\))/g, '$$$1^{$3}$$');
        
        // AKILLI DÜZELTME 3: Eğer metinde \frac, \sqrt gibi LaTeX komutları varsa
        // ve $ işareti yoksa, otomatik olarak $ içine alalım.
        if (text.includes('\\') && !text.includes('$')) {
            text = text.replace(/([^\s$]*\\[^\s$]*)/g, '$$$1$$');
        }

        // Satır sonlarını ayarla
        preview.innerHTML = text.replace(/\n/g, '<br>');

        stiliUygula();

        // KaTeX Render İşlemi
        try {
            renderMathInElement(preview, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false},
                    {left: "\\(", right: "\\)", display: false},
                    {left: "\\[", right: "\\]", display: true}
                ],
                throwOnError : false
            });
        } catch (e) {
            console.error("Render hatası:", e);
        }
    }

    function pngIndir() {
        const preview = document.getElementById('preview');
        
        // Geçici olarak border ve background'u kaldır
        const originalBorder = preview.style.border;
        const originalBackground = preview.style.background;
        
        preview.style.border = 'none';
        preview.style.background = 'transparent';
        
        html2canvas(preview, {
            backgroundColor: null, // Şeffaf arka plan
            scale: 2, // Daha yüksek kalite için
            logging: false,
            useCORS: true
        }).then(canvas => {
            // Border ve background'u geri yükle
            preview.style.border = originalBorder;
            preview.style.background = originalBackground;
            
            // PNG olarak indir
            const link = document.createElement('a');
            link.download = 'matematik-render.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            console.error('PNG indirme hatası:', err);
            alert('PNG indirme sırasında bir hata oluştu.');
            
            // Hata durumunda da stilleri geri yükle
            preview.style.border = originalBorder;
            preview.style.background = originalBackground;
        });
    }
</script>

</body>
</html>
