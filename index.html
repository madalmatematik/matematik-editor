<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matematiksel Metin Düzenleyici</title>

  <!-- KaTeX (ONLINE) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

  <!-- html2canvas + jsPDF (ONLINE) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg1:#6a4bdc;
      --bg2:#3c86ff;
      --card:#ffffff;
      --muted:#6b7280;
      --border:#d1d5db;
      --soft:#f3f4f6;
      --shadow: 0 10px 30px rgba(0,0,0,.18);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      padding: 18px;
      color:#111827;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
    }
    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 14px;
    }
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 6px 4px 10px;
      border-bottom: 3px solid rgba(60,134,255,.25);
      margin-bottom: 14px;
    }
    .title{
      font-size: 22px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .rightHead{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .status{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background:#eef2ff;
      color:#3730a3;
      border:1px solid rgba(55,48,163,.25);
      user-select:none;
    }
    .toggle{
      display:flex; align-items:center; gap:8px;
      font-size: 13px;
      color:#111827;
      user-select:none;
    }
    .toggle input{width:18px;height:18px}

    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin: 12px 0;
    }

    .label{
      font-size: 12px;
      color: var(--muted);
      margin: 2px 0 6px;
      font-style: italic;
    }

    textarea{
      width:100%;
      min-height: 132px;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid var(--border);
      outline:none;
      background:#fff;
      font-size: 14px;
      line-height: 1.4;
      resize: vertical;
      white-space: pre-wrap;
    }
    textarea:focus{border-color:#7c3aed}

    .controls{
      background: #f8fafc;
      border-radius: 14px;
      padding: 14px;
      border: 1px solid rgba(209,213,219,.7);
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
    }
    .ctrl{
      background:#fff;
      border: 1px solid rgba(209,213,219,.7);
      border-radius: 12px;
      padding: 10px;
    }
    .ctrl .ct{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .ctrlRow{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }
    select, input[type="number"], input[type="color"]{
      border: 1px solid rgba(209,213,219,.9);
      border-radius: 10px;
      padding: 10px 10px;
      background:#fff;
      outline:none;
      font-size: 14px;
      min-width: 120px;
    }
    input[type="number"]{min-width: 110px}
    input[type="color"]{
      padding: 0;
      height: 42px;
      width: 64px;
      min-width: 64px;
    }
    .checkLine{
      display:flex; align-items:center; gap:8px;
      font-size: 14px;
      color:#111827;
      user-select:none;
    }
    .checkLine input{width:18px;height:18px}

    .btns{
      display:grid;
      grid-template-columns: repeat(5, minmax(0,1fr));
      gap: 10px;
      margin-top: 12px;
    }
    button{
      border:0;
      border-radius: 12px;
      padding: 12px 10px;
      font-weight: 800;
      letter-spacing: .3px;
      cursor:pointer;
      color:#fff;
      min-height: 46px;
    }
    .b1{background: linear-gradient(135deg,#6366f1,#8b5cf6)}
    .b2{background: linear-gradient(135deg,#ec4899,#f97316)}
    .b3{background: linear-gradient(135deg,#06b6d4,#3b82f6)}
    .b4{background: linear-gradient(135deg,#fb7185,#f59e0b)}
    .b5{background: linear-gradient(135deg,#64748b,#4f46e5)}
    button:active{transform: translateY(1px)}

    .hint{
      margin-top: 10px;
      border: 2px solid #f59e0b;
      background: #fff7ed;
      border-radius: 12px;
      padding: 10px 12px;
      color:#7c2d12;
      font-size: 13px;
      line-height: 1.35;
    }

    .previewWrap{
      margin-top: 12px;
      border: 2px dashed rgba(107,114,128,.35);
      border-radius: 14px;
      padding: 12px;
      background: #ffffff;
      overflow:auto;
      min-height: 200px;
    }

    /* Preview: normal metin fontu kalsın */
    #preview{
      font-family: Arial, Helvetica, sans-serif;
      font-style: normal;
      line-height: 1.65;
      white-space: pre-wrap;
      word-break: break-word;
      text-align: justify; /* ilk açılış: iki yana yasla */
      color: #111827;
    }

    /* KaTeX sadece matematikte devreye girsin */
    #preview .katex{ font-style: normal; }
    #preview .katex-display{ text-align:center; margin: .65em 0; }

    /* Geçmiş */
    .history{
      margin-top: 14px;
      background: #f8fafc;
      border-radius: 14px;
      border: 1px solid rgba(209,213,219,.7);
      padding: 12px;
    }
    .historyTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom: 8px;
      color:#111827;
      font-weight: 800;
    }
    .hItem{
      background:#fff;
      border: 1px solid rgba(209,213,219,.65);
      border-radius: 12px;
      padding: 10px;
      margin-top: 8px;
      cursor:pointer;
      overflow:hidden;
    }
    .hItem pre{
      margin:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      color:#111827;
    }

    .smallNote{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }

    @media (max-width: 860px){
      .controls{grid-template-columns: 1fr}
      .btns{grid-template-columns: 1fr 1fr}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="title">Matematiksel Metin Düzenleyici</div>
        <div class="rightHead">
          <div id="katexStatus" class="status">KaTeX: kontrol ediliyor…</div>
          <label class="toggle" title="İlk açılışta kapalıdır. İlk GÖRÜNTÜLE’den sonra otomatik açılır.">
            <input id="autoRenderChk" type="checkbox" />
            <span>Otomatik Render</span>
          </label>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="label" style="font-style:normal;font-weight:800;letter-spacing:.2px;color:#374151;">ÖRNEK ŞABLONLAR</div>
          <select id="templateSelect">
            <option value="empty">Seçiniz…</option>
            <option value="trig">Trigonometri</option>
            <option value="derivative">Türev Örneği</option>
            <option value="integral">İntegral Örneği</option>
            <option value="matrix">Matris</option>
            <option value="limit">Limit Örneği</option>
            <option value="parabola">Parabol Fonksiyonu</option>
          </select>
        </div>

        <div>
          <div id="templateLabel" class="label">Metin / LaTeX alanı</div>
          <textarea id="inputText" placeholder="Metninizi buraya yapıştırın. Örn: y(t)=5\sqrt{2}\cdot \sin(4t^\circ)"></textarea>
          <div class="smallNote">
            İpucu: Metin ile matematiği karıştırabilirsiniz. Örn: “Denklemi kuralım: 5\sqrt{2}\cdot \sin(4t) = -5”.
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="ctrl">
          <div class="ct">YAZI TİPİ</div>
          <div class="ctrlRow">
            <select id="fontFamily">
              <option value="Arial, Helvetica, sans-serif" selected>Arial</option>
              <option value="Georgia, serif">Georgia</option>
              <option value="Times New Roman, Times, serif">Times New Roman</option>
              <option value="Trebuchet MS, sans-serif">Trebuchet MS</option>
              <option value="Verdana, sans-serif">Verdana</option>
            </select>
          </div>
        </div>

        <div class="ctrl">
          <div class="ct">BOYUT (PX)</div>
          <div class="ctrlRow">
            <input id="fontSize" type="number" min="10" max="72" value="22">
          </div>
        </div>

        <div class="ctrl">
          <div class="ct">METİN RENGİ</div>
          <div class="ctrlRow">
            <input id="textColor" type="color" value="#111827">
          </div>
        </div>

        <div class="ctrl">
          <div class="ct">ARKA PLAN</div>
          <div class="ctrlRow">
            <input id="bgColor" type="color" value="#ffffff">
            <label class="checkLine">
              <input id="transparentBg" type="checkbox" checked>
              <span>Şeffaf</span>
            </label>
          </div>
        </div>

        <div class="ctrl">
          <div class="ct">HİZALAMA</div>
          <div class="ctrlRow">
            <select id="alignSelect">
              <option value="left">Sola</option>
              <option value="center">Ortala</option>
              <option value="right">Sağa</option>
              <option value="justify" selected>İki yana yasla</option>
            </select>
          </div>
        </div>

        <div class="ctrl">
          <div class="ct">STİL</div>
          <div class="ctrlRow">
            <label class="checkLine">
              <input id="boldChk" type="checkbox">
              <span>Kalın</span>
            </label>
          </div>
        </div>
      </div>

      <div class="btns">
        <button class="b1" id="renderBtn">GÖRÜNTÜLE</button>
        <button class="b2" id="clearBtn">TEMİZLE</button>
        <button class="b3" id="copyBtn">KOPYALA</button>
        <button class="b4" id="pngBtn">PNG İNDİR</button>
        <button class="b5" id="pdfBtn">PDF İNDİR</button>
      </div>

      <div class="hint">
        <b>Şeffaf PNG için:</b> Şeffaf seçeneğini işaretleyin, sonra preview alanına uzun basıp/sağ tıklayıp “Resim olarak kaydet” (cihaza göre değişebilir) veya “PNG İNDİR” butonunu kullanın.
      </div>

      <div class="previewWrap" id="previewWrap">
        <div id="preview"></div>
      </div>

      <div class="history">
        <div class="historyTitle">
          <div>GEÇMİŞ (Son 5)</div>
          <div class="smallNote">Bir kayda dokunarak tekrar yükleyebilirsiniz.</div>
        </div>
        <div id="historyList"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const inputText = $("inputText");
  const preview = $("preview");
  const previewWrap = $("previewWrap");

  const templateSelect = $("templateSelect");
  const templateLabel  = $("templateLabel");

  const fontFamily = $("fontFamily");
  const fontSize   = $("fontSize");
  const textColor  = $("textColor");
  const bgColor    = $("bgColor");
  const transparentBg = $("transparentBg");
  const alignSelect = $("alignSelect");
  const boldChk   = $("boldChk");

  const autoRenderChk = $("autoRenderChk");
  const katexStatus = $("katexStatus");

  const renderBtn = $("renderBtn");
  const clearBtn  = $("clearBtn");
  const copyBtn   = $("copyBtn");
  const pngBtn    = $("pngBtn");
  const pdfBtn    = $("pdfBtn");

  const historyList = $("historyList");

  // İstenen davranış:
  // - Otomatik render ilk açılışta kapalı
  // - İlk "GÖRÜNTÜLE" tıklanınca otomatik render aktif olsun (checkbox da işaretlensin)
  let autoModeEnabled = false;

  // Debounce (her yazımda render yapmasın)
  let tmr = null;
  function debounceRender(){
    clearTimeout(tmr);
    tmr = setTimeout(()=> renderPreview(false), 250);
  }

  // KaTeX yük durumu (CDN erişimi + script load)
  function updateKaTeXStatus(){
    const ok = (window.katex && typeof window.renderMathInElement === "function");
    katexStatus.textContent = ok ? "KaTeX: hazır (online)" : "KaTeX: yüklenemedi";
    katexStatus.style.background = ok ? "#ecfeff" : "#fef2f2";
    katexStatus.style.color = ok ? "#0e7490" : "#991b1b";
    katexStatus.style.borderColor = ok ? "rgba(14,116,144,.25)" : "rgba(153,27,27,.25)";
    return ok;
  }
  // defer scriptler sonrası kontrol
  window.addEventListener("load", ()=> setTimeout(updateKaTeXStatus, 60));

  // Şablonlar
  const templates = {
    empty: { label: "Metin / LaTeX alanı", text: "" },
    trig: { label: "Trigonometrik özdeşlik", text: "\\sin^2(x) + \\cos^2(x) = 1" },
    derivative: { label: "Türev alma örneği", text: "f(x) = 3x^2 + 2x - 5\nf'(x) = 6x + 2" },
    integral: { label: "Belirli integral örneği", text: "\\int_{0}^{1} x^2\\,dx = \\frac{1}{3}" },
    matrix: { label: "Matris gösterimi", text: "\\begin{pmatrix} a & b \\\\ c & d \\end{pmatrix}" },
    limit: { label: "Limit hesaplama örneği", text: "\\lim_{x \\to 0} \\frac{\\sin x}{x} = 1" },
    parabola: { label: "Parabol fonksiyonu örneği", text: "f(x) = x^2 - 4x + 3\nTepe noktası: (2, -1)" }
  };

  templateSelect.addEventListener("change", ()=>{
    const key = templateSelect.value;
    const tpl = templates[key] || templates.empty;
    templateLabel.textContent = tpl.label || "Metin / LaTeX alanı";
    if(key !== "empty"){
      inputText.value = tpl.text;
      renderPreview(false);
    }
  });

  // Ayarları preview'a uygula (metin bozulmadan)
  function applyStyle(){
    preview.style.fontFamily = fontFamily.value;
    preview.style.fontSize = `${Number(fontSize.value || 22)}px`;
    preview.style.color = textColor.value || "#111827";
    preview.style.fontWeight = boldChk.checked ? "700" : "400";

    // Hizalama: preview metni
    const a = alignSelect.value;
    preview.style.textAlign = a;

    // Arkaplan
    if(transparentBg.checked){
      previewWrap.style.background = "transparent";
      previewWrap.style.borderColor = "rgba(209,213,219,.65)";
    }else{
      previewWrap.style.background = bgColor.value || "#ffffff";
    }
  }

  // Kopyala-yapıştırla gelen metinlerde matematik parçalarını yakalamak için
  // - satır matematikse $$...$$
  // - metin içindeki latex tokenları \( ... \)
  function autoDelimitLatex(raw){
    const lines = (raw || "").replace(/\r\n/g,"\n").split("\n");

    const looksLikeStep = (s)=> /^\s*\d+\.\s+/.test(s.trim());

    const isMathLine = (s)=>{
      const t = s.trim();
      if(!t) return false;

      // Eğer satır "1. Denklem..." gibi adım cümlesiyse satırı komple math yapma
      if(looksLikeStep(t)) return false;

      const hasLatexCmd = /\\(frac|sqrt|sin|cos|tan|cot|sec|csc|lim|int|begin|end|cdot|times|Rightarrow|implies|to|pi|theta|circ|sum|prod)\b/.test(t);
      const hasMathOps = /[=^_]/.test(t);
      const hasLetters = /[a-zA-ZğüşöçıİĞÜŞÖÇ]/.test(t.replace(/\\[a-zA-Z]+/g,""));

      // Saf latex gibi görünen kısa satırlar genelde math satırıdır
      if(hasLatexCmd && (hasMathOps || !hasLetters) && t.length < 180) return true;

      // f(x)=..., x^2... gibi belirgin ifadeler
      if(/[=]/.test(t) && (hasLatexCmd || /[0-9][a-zA-Z]|\b[fgy]\(x\)/.test(t)) && t.length < 180) return true;

      return false;
    };

    const wrapInlineTokens = (s)=>{
      // \sqrt{2}, \frac{1}{2}, \sin(4t^\circ) gibi komut içeren parçaları inline yap
      // Çok agresif olmamak için: boşluklarla çevrili "komutlu" parçaları hedefle
      return s.replace(/(^|[\s:;,(])((?:[0-9]*\s*)?\\[a-zA-Z]+(?:\{[^}]*\})*(?:\([^\)]*\))?(?:\^\{[^}]*\}|\^[^\s,.;:)]*)?(?:_\{[^}]*\}|_[^\s,.;:)]*)?)/g,
        (m, p1, p2) => `${p1}\\(${p2}\\)`);
    };

    const out = lines.map(line=>{
      if(isMathLine(line)){
        return `$$${line.trim()}$$`;
      }
      return wrapInlineTokens(line);
    });

    return out.join("\n");
  }

  function renderWithKaTeX(prepared){
    // Önce düz metin bas (HTML kaçış problemi yok)
    preview.textContent = prepared;

    // KaTeX yüklüyse, delimiterlara göre sadece math parçalarını render et
    if(window.renderMathInElement){
      try{
        window.renderMathInElement(preview, {
          delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "\\[", right: "\\]", display: true },
            { left: "$", right: "$", display: false },
            { left: "\\(", right: "\\)", display: false }
          ],
          throwOnError: false
        });
      }catch(e){
        console.error("KaTeX render error:", e);
      }
    }
  }

  function renderPreview(addToHistory){
    applyStyle();

    const raw = inputText.value || "";
    const prepared = autoDelimitLatex(raw);

    // KaTeX durumunu güncelle
    updateKaTeXStatus();

    renderWithKaTeX(prepared);

    if(addToHistory){
      pushHistory(raw);
      drawHistory();
    }
  }

  // İlk render sonrası otomatik mod: uygulamayı kapatana kadar
  function enableAutoMode(){
    autoModeEnabled = true;
    autoRenderChk.checked = true; // kullanıcı isteği: tıklayınca seçili hale gelsin
  }

  // Otomatik render checkbox: kullanıcı isterse manuel de açıp kapatsın
  autoRenderChk.addEventListener("change", ()=>{
    autoModeEnabled = autoRenderChk.checked;
    if(autoModeEnabled) debounceRender();
  });

  // İlk açılış: şeffaf + justify seçili (ZATEN HTML default)
  applyStyle();

  // Yazımda otomatik render (autoModeEnabled ise)
  inputText.addEventListener("input", ()=>{
    if(autoModeEnabled) debounceRender();
  });

  // Kontrol değişince (font/renk/hiza vb) otomatik mod açıkken render
  [fontFamily, fontSize, textColor, bgColor, transparentBg, alignSelect, boldChk].forEach(el=>{
    el.addEventListener("change", ()=>{
      applyStyle();
      if(autoModeEnabled) debounceRender();
    });
  });

  // Butonlar
  renderBtn.addEventListener("click", ()=>{
    enableAutoMode();         // ilk tıklamada otomatik modu aç
    renderPreview(true);      // geçmişe ekle
  });

  clearBtn.addEventListener("click", ()=>{
    inputText.value = "";
    preview.textContent = "";
  });

  copyBtn.addEventListener("click", async ()=>{
    const raw = inputText.value || "";
    try{
      await navigator.clipboard.writeText(raw);
      alert("Kopyalandı.");
    }catch(e){
      // fallback
      inputText.select();
      document.execCommand("copy");
      alert("Kopyalandı.");
    }
  });

  async function downloadPNG(){
    applyStyle();
    if(window.html2canvas){
      const canvas = await window.html2canvas(previewWrap, {
        backgroundColor: transparentBg.checked ? null : (bgColor.value || "#ffffff"),
        scale: 2
      });
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = "matematik.png";
      a.click();
    }else{
      alert("html2canvas yüklenemedi.");
    }
  }

  async function downloadPDF(){
    applyStyle();
    if(!window.html2canvas){
      alert("html2canvas yüklenemedi.");
      return;
    }
    const canvas = await window.html2canvas(previewWrap, {
      backgroundColor: transparentBg.checked ? "#ffffff" : (bgColor.value || "#ffffff"),
      scale: 2
    });

    const imgData = canvas.toDataURL("image/png");
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF){
      alert("jsPDF yüklenemedi.");
      return;
    }

    // A4: 210x297 mm
    const pdf = new jsPDF("p", "mm", "a4");
    const pageW = 210;
    const pageH = 297;

    // Görseli sayfaya sığdır
    const imgW = pageW - 20;
    const imgH = (canvas.height * imgW) / canvas.width;

    let y = 10;
    if(imgH <= pageH - 20){
      pdf.addImage(imgData, "PNG", 10, y, imgW, imgH);
    }else{
      // Çok uzunsa sayfalara böl (basit kırpma)
      let remaining = imgH;
      let offset = 0;

      while(remaining > 0){
        pdf.addImage(imgData, "PNG", 10, 10 - offset, imgW, imgH);
        remaining -= (pageH - 20);
        offset += (pageH - 20);
        if(remaining > 0) pdf.addPage();
      }
    }

    pdf.save("matematik.pdf");
  }

  pngBtn.addEventListener("click", ()=> downloadPNG());
  pdfBtn.addEventListener("click", ()=> downloadPDF());

  // Geçmiş (son 5)
  const HISTORY_KEY = "math_editor_history_v1";
  function getHistory(){
    try{
      const x = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
      return Array.isArray(x) ? x : [];
    }catch(_){ return []; }
  }
  function setHistory(arr){
    localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
  }
  function pushHistory(raw){
    const h = getHistory();
    const cleaned = (raw || "").trim();
    if(!cleaned) return;

    // aynıysa tekrar ekleme
    if(h[0] === cleaned) return;

    h.unshift(cleaned);
    const sliced = h.slice(0,5);
    setHistory(sliced);
  }
  function drawHistory(){
    const h = getHistory();
    historyList.innerHTML = "";
    h.forEach((txt)=>{
      const div = document.createElement("div");
      div.className = "hItem";
      const pre = document.createElement("pre");
      pre.textContent = txt;
      div.appendChild(pre);
      div.addEventListener("click", ()=>{
        inputText.value = txt;
        renderPreview(false);
        // otomatik mod açık ise yazınca anında güncellesin
        if(autoModeEnabled) debounceRender();
      });
      historyList.appendChild(div);
    });
  }
  drawHistory();

  // İlk açılışta preview boş; otomatik render kapalı
  // (İstersen buraya demo başlangıç metni koyabilirsin.)
})();
</script>
</body>
</html>
